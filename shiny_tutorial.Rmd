---
title: "Développement d'une application Shiny"
author:
  - name: "Amandine Velt"
    orcid: "0000-0002-3287-0786"
    affiliations: "SVQV"
  - name: "Joseph Tran"
    orcid: "0000-0002-4624-0363"
    affiliations: "EGFV"
date: "2024-03-19"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
description: >
  Learn how to build a shiny application.
---

```{r setup, include=FALSE}
library(learnr)
```


## Introduction

### Iris dataset

Pour le tutoriel, nous allons utiliser un jeu de données intégré à R, nommé Iris. Il recense les tailles de pétales et de sépales pour un ensemble d'individus "iris" de trois espèces différentes, setosa, versicolor et virginica.

Exécuter le code suivant, bouton `Run code`, pour afficher les premières lignes du jeu de données:

```{r iris, exercise=TRUE}
head(iris)
```

## Développer une application Shiny

### Créer une application Shiny

Créer un répertoire pour l’application avec **RStudio**.

```bash
File -> New Project -> New Directory -> Shiny Web Application
```

Choisir une application **Multiple File**.

Si cette option n’est pas disponible (ça peut dépendre des versions de Rstudio), on pourra utiliser

```bash
File -> New File -> Shiny Web App -> Multiple File
```

Deux fichier sont automatiquement générés : `ui.R` et `server.R`. Lancer l’application en cliquant sur le bouton `Run App`.

  * Changer le titre de l’application. On pourra l’appeler My first application.
  * Mettre à jour et vérifier que le titre a bien été changé.

### ui.R

Voici un exemple de `ui.R` que nous allons utiliser.

```{r ui_R, exercise=TRUE}
# k-means only works with numerical variables,
# so don't give the user the option to select
# a categorical variable
vars <- setdiff(names(iris), "Species")

pageWithSidebar(
  headerPanel('Iris k-means clustering'),
  sidebarPanel(
    selectInput('xcol', 'X Variable', vars),
    selectInput('ycol', 'Y Variable', vars, selected = vars[[2]]),
    numericInput('clusters', 'Cluster count', 3, min = 1, max = 9)
  ),
  mainPanel(
    tabsetPanel(type = "tabs",
                tabPanel("Plot", plotOutput('plot1')),
                tabPanel("Summary", verbatimTextOutput("summary")),
                tabPanel("Table", tableOutput("table"))
    )
  )
)
```

### server.R

Exemple de fichier server.R vide : 

```{r server_R, exercise=FALSE, eval=FALSE}
function(input, output, session) {

}
```

Il s'agit maintenant de remplir le fichier server.R pour obtenir des résultats dans les tabPanel "Plot", "Summary" et "Table".  

### Générer un tableau dynamique dans une fonction reactive({})

Créer une reactive avec reactive({}) pour générer un tableau dynamique récupérant les 2 colonnes correspondant aux variables X et Y sélectionnées par l’utilisateur sur les données iris et ranger ce tableau dans une variable « selectedData »

```{r server_R_selected_data, exercise=TRUE}
function(input, output, session) {

}
```

```{r server_R_selected_data-solution}
function(input, output, session) {
  
  # Combine the selected variables into a new data frame
  selectedData <- reactive({
    iris[, c(input$xcol, input$ycol)]
  })
}
```

### Générer le clustering k-means dasn une fonction reactive({})

Créer une reactive avec reactive({}) pour générer un cluster sur le tableau dynamique précédent, utilisant la variable « Cluster count » comme nombre de clusters à créer et ranger ce résultat dans une variable « clusters ». Utiliser la fonction kmeans() pour générer ces clusters.

```{r server_R_clusters, exercise=TRUE}
function(input, output, session) {

}
```

```{r server_R_clusters-solution}
function(input, output, session) {
  
  # Combine the selected variables into a new data frame
  selectedData <- reactive({
    iris[, c(input$xcol, input$ycol)]
  })
  
  clusters <- reactive({
    kmeans(selectedData(), input$clusters)
  })
}
```

### Générer le plot dynamique du clustering kmeans  

Générer un graphique dynamique avec renderPlot{()} représentant le tableau dynamique avec la fonction plot() et colorer les points selon le cluster auquel ils appartiennent avec le paramètre « col ». Pour récupérer les clusters depuis la variable « clusters », utiliser clusters()\$cluster. Ranger le résultat dans output\$plot1 et le représenter côté UI dans le tabPanel « Plot ».

```{r server_R_render_plot, exercise=TRUE}
function(input, output, session) {

}
```

```{r server_R_render_plot-solution}
function(input, output, session) {
  
  # Combine the selected variables into a new data frame
  selectedData <- reactive({
    iris[, c(input$xcol, input$ycol)]
  })
  
  clusters <- reactive({
    kmeans(selectedData(), input$clusters)
  })
  
  output$plot1 <- renderPlot({
    palette(c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3",
              "#FF7F00", "#FFFF33", "#A65628", "#F781BF", "#999999"))
    
    par(mar = c(5.1, 4.1, 0, 1))
    plot(selectedData(),
         col = clusters()$cluster,
         pch = 20, cex = 3)
    points(clusters()$centers, pch = 4, cex = 4, lwd = 4)
  })
}
```

### Générer un résumé statistique du tableau dynamique

Générer un texte dynamique avec renderPrint({}) représentant un résumé statistique du tableau dynamique généré précédemment avec la fonction summary() et ranger le résultat dans output$summary, puis le représenter côté UI dans le tabPanel « Summary ».

```{r server_R_render_print, exercise=TRUE}
function(input, output, session) {

}
```

```{r server_R_render_print-solution}
function(input, output, session) {
  
  # Combine the selected variables into a new data frame
  selectedData <- reactive({
    iris[, c(input$xcol, input$ycol)]
  })
  
  clusters <- reactive({
    kmeans(selectedData(), input$clusters)
  })
  
  output$plot1 <- renderPlot({
    palette(c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3",
              "#FF7F00", "#FFFF33", "#A65628", "#F781BF", "#999999"))
    
    par(mar = c(5.1, 4.1, 0, 1))
    plot(selectedData(),
         col = clusters()$cluster,
         pch = 20, cex = 3)
    points(clusters()$centers, pch = 4, cex = 4, lwd = 4)
  })

  # Generate a summary of the data ----
  output$summary <- renderPrint({
    summary(selectedData())
  })
}
```

### Générer un tableau des données sélectionnées pour le graphique

Afficher le tableau dynamique avec renderTable{()} représentant le tableau utilisé pour générer le graphique et ranger le résultat dans output$table. Représenter cette table côté UI dans le tabPanel « Table ».  

```{r server_R_render_table, exercise=TRUE}
function(input, output, session) {

}
```

```{r server_R_render_table-solution}
function(input, output, session) {
  
  # Combine the selected variables into a new data frame
  selectedData <- reactive({
    iris[, c(input$xcol, input$ycol)]
  })
  
  clusters <- reactive({
    kmeans(selectedData(), input$clusters)
  })
  
  output$plot1 <- renderPlot({
    palette(c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3",
              "#FF7F00", "#FFFF33", "#A65628", "#F781BF", "#999999"))
    
    par(mar = c(5.1, 4.1, 0, 1))
    plot(selectedData(),
         col = clusters()$cluster,
         pch = 20, cex = 3)
    points(clusters()$centers, pch = 4, cex = 4, lwd = 4)
  })

  # Generate a summary of the data ----
  output$summary <- renderPrint({
    summary(selectedData())
  })
  
  output$table <- renderTable({
    selectedData()
  })
}
```

## Application Shiny complète

### Lancer une application Shiny

Tips, commande pour lancer une application Shiny dans le dossier contenant les fichiers ui.R et server.R. Avec "." le chemin vers le dossier contenant les deux scripts.

```{r shiny_run_app, exercise=FALSE, eval=FALSE}
shiny::runApp(".")
```

### L'application shiny en démo live  

Si vous avez exécuter la commande ``shiny::runApp(".")`` dans la console, vous pouvez voir l'application en démo live ci-dessous.

```{r shiny_run_app_demo, echo=FALSE}
# k-means only works with numerical variables,
# so don't give the user the option to select
# a categorical variable
vars <- setdiff(names(iris), "Species")

pageWithSidebar(
  headerPanel('Iris k-means clustering'),
  sidebarPanel(
    selectInput('xcol', 'X Variable', vars),
    selectInput('ycol', 'Y Variable', vars, selected = vars[[2]]),
    numericInput('clusters', 'Cluster count', 3, min = 1, max = 9)
  ),
  mainPanel(
    tabsetPanel(type = "tabs",
                tabPanel("Plot", plotOutput('plot1')),
                tabPanel("Summary", verbatimTextOutput("summary")),
                tabPanel("Table", tableOutput("table"))
    )
  )
)

```

```{r shiny_run_app_demo_server, context="server"}
# Combine the selected variables into a new data frame
selectedData <- reactive({
  iris[, c(input$xcol, input$ycol)]
})

clusters <- reactive({
  kmeans(selectedData(), input$clusters)
})

output$plot1 <- renderPlot({
  palette(c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3",
            "#FF7F00", "#FFFF33", "#A65628", "#F781BF", "#999999"))
  
  par(mar = c(5.1, 4.1, 0, 1))
  plot(selectedData(),
       col = clusters()$cluster,
       pch = 20, cex = 3)
  points(clusters()$centers, pch = 4, cex = 4, lwd = 4)
})

# Generate a summary of the data ----
output$summary <- renderPrint({
  summary(selectedData())
})

output$table <- renderTable({
  selectedData()
})

```
